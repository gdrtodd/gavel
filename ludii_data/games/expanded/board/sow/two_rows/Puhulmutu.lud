(game "Puhulmutu" (players 2) (equipment {(mancalaBoard 2 7 {(track "TrackCCW" "1,E,N,W" loop:True) (track "TrackCW" "7,W,N,E" loop:True)}) (piece "Seed" Shared) (regions P1 (sites Bottom)) (regions P2 (sites Top)) (map {(pair P1 FirstSite) (pair P2 LastSite)})}) (rules (start {(set Count 4 to:(sites Track)) (set RememberValue "Playable" (union (sites Top) (sites Bottom)))}) phases:{(phase "StartingMove" (play (or (move Select (from (sites Mover) if:(and (is Occupied (from)) (is In (from) (sites (values Remembered "Playable"))))) (then (and (sow "TrackCCW" apply:(if (= 4 (count at:(to))) (and (if (!= 0 (count at:(trackSite Move from:(to) "TrackCCW" steps:1))) (and (moveAgain) (set Var "Replay" (trackSite Move from:(to) "TrackCCW" steps:1)))) (fromTo (from (to)) (to (mapEntry Mover)) count:4)) (if (< 1 (count at:(to))) (and (moveAgain) (set Var "Replay" (to))))) skipIf:(or (not (is In (to) (sites (values Remembered "Playable")))) (and (= 3 (count at:(to))) (!= 1 (value))))) (set Var "Direction" 1)))) (move Select (from (sites Mover) if:(and (is Occupied (from)) (is In (from) (sites (values Remembered "Playable"))))) (then (and (sow "TrackCW" apply:(if (= 4 (count at:(to))) (and (if (!= 0 (count at:(trackSite Move from:(to) "TrackCW" steps:1))) (and (moveAgain) (set Var "Replay" (trackSite Move from:(to) "TrackCW" steps:1)))) (fromTo (from (to)) (to (mapEntry Mover)) count:4)) (if (< 1 (count at:(to))) (and (moveAgain) (set Var "Replay" (to))))) skipIf:(or (not (is In (to) (sites (values Remembered "Playable")))) (and (= 3 (count at:(to))) (!= 1 (value))))) (set Var "Direction" 2)))))) (nextPhase "Sowing")) (phase "Sowing" (play (if (= 1 (var "Direction")) (move Select (from (if (and (not (is Pending)) (is Prev Mover)) (sites {(var "Replay")}) (sites Mover)) if:(and {(is Occupied (from)) (is In (from) (sites (values Remembered "Playable"))) (not (is In (from) (sites (values Remembered "Blocked")))) (if (not (all Sites (forEach (sites Mover) if:(is In (site) (sites (values Remembered "Playable")))) if:(>= 1 (count at:(site))))) (< 1 (count at:(from))))})) (then (sow "TrackCCW" apply:(if (= 4 (count at:(to))) (and (if (!= 0 (count at:(trackSite Move from:(to) "TrackCCW" steps:1))) (and (moveAgain) (set Var "Replay" (trackSite Move from:(to) "TrackCCW" steps:1)))) (if (not (is In (to) (sites (values Remembered "Blocked")))) (fromTo (from (to)) (to (mapEntry Mover)) count:4))) (if (< 1 (count at:(to))) (and (moveAgain) (set Var "Replay" (to))))) skipIf:(or (not (is In (to) (sites (values Remembered "Playable")))) (and (= 3 (count at:(to))) (!= 1 (value))))))) (move Select (from (if (and (not (is Pending)) (is Prev Mover)) (sites {(var "Replay")}) (sites Mover)) if:(and {(is Occupied (from)) (is In (from) (sites (values Remembered "Playable"))) (not (is In (from) (sites (values Remembered "Blocked")))) (if (not (all Sites (forEach (sites Mover) if:(is In (site) (sites (values Remembered "Playable")))) if:(>= 1 (count at:(site))))) (< 1 (count at:(from))))})) (then (sow "TrackCW" apply:(if (= 4 (count at:(to))) (and (if (!= 0 (count at:(trackSite Move from:(to) "TrackCW" steps:1))) (and (moveAgain) (set Var "Replay" (trackSite Move from:(to) "TrackCW" steps:1)))) (if (not (is In (to) (sites (values Remembered "Blocked")))) (fromTo (from (to)) (to (mapEntry Mover)) count:4))) (if (< 1 (count at:(to))) (and (moveAgain) (set Var "Replay" (to))))) skipIf:(or (not (is In (to) (sites (values Remembered "Playable")))) (and (= 3 (count at:(to))) (!= 1 (value))))))) (then (if (no Moves Next) (and {(forEach Site (sites P1) (if (is Occupied (site)) (fromTo (from (site)) (to (mapEntry P1)) count:(count at:(site))))) (forEach Site (sites P2) (if (is Occupied (site)) (fromTo (from (site)) (to (mapEntry P2)) count:(count at:(site))))) (forget Value "Playable" All) (forget Value "Blocked" All) (if (< (+ (count at:(mapEntry P1)) (count in:(sites P1))) (+ (count at:(mapEntry P2)) (count in:(sites P2)))) (and (set NextPlayer (player 2)) (set Var "Winner" 2)) (and (set NextPlayer (player 1)) (set Var "Winner" 1)))}))))) (end (if (no Moves Next) {(if (> 2 (count at:(mapEntry P1))) (result P2 Win)) (if (> 2 (count at:(mapEntry P2))) (result P1 Win))})) (nextPhase (no Moves Next) "BetweenRounds")) (phase "BetweenRounds" (play (if (and (not (is Prev Mover)) (!= (mover) (var "Winner"))) (or (move (from (mapEntry Mover)) (to (if (is Mover P1) (intersection (sites Bottom) (expand (sites Right))) (intersection (sites Top) (expand (sites Left)))) if:(is Empty (to))) count:(min 4 (count at:(mapEntry Mover))) (then (and {(remember Value "Playable" (last To)) (if (> 4 (count at:(last To))) (and (fromTo (from (if (is Mover P1) (+ (to) 7) (- (to) 7))) (to (mapEntry Next)) count:(- 4 (count at:(last To)))) (remember Value "Blocked" (last To)))) (moveAgain) (if (= 0 (count at:(mapEntry Mover))) (set Pending)) (set Var "Direction" 2)}))) (move (from (mapEntry Mover)) (to (if (is Mover P1) (intersection (sites Bottom) (expand (sites Left))) (intersection (sites Top) (expand (sites Right)))) if:(is Empty (to))) count:(min 4 (count at:(mapEntry Mover))) (then (and {(remember Value "Playable" (last To)) (if (> 4 (count at:(last To))) (and (fromTo (from (if (is Mover P1) (+ (to) 7) (- (to) 7))) (to (mapEntry Next)) count:(- 4 (count at:(last To)))) (remember Value "Blocked" (last To)))) (moveAgain) (if (= 0 (count at:(mapEntry Mover))) (set Pending)) (set Var "Direction" 1)})))) (if (!= (mover) (var "Winner")) (move (from (mapEntry Mover)) (to (if (= (var "Direction") 1) (trackSite Move from:(last To) "TrackCCW" steps:1) (trackSite Move from:(last To) "TrackCW" steps:1)) if:(is Empty (to))) count:(min 4 (count at:(mapEntry Mover))) (then (and {(remember Value "Playable" (last To)) (moveAgain) (if (= 0 (count at:(mapEntry Mover))) (set Pending))}))) (move (from (mapEntry Mover)) (to (sites Mover) if:(is Empty (to))) count:4 (then (and (remember Value "Playable" (last To)) (if (not (all Sites (sites Mover) if:(is Occupied (site)))) (moveAgain)))))))) (nextPhase (and (!= (var "Winner") (mover)) (= 0 (count at:(mapEntry Mover)))) "Sowing"))})) 