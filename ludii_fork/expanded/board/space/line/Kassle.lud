DROP - A player, on his turn, can drop a stone on an empty cell. SHIFT - Instead of dropping a stone, the player may decide to shift one row or column, one cell left/right (for rows) or up/down (for columns). All stones are shifted on the chosen direction. If a stone is shifted off-board, it is placed on the other end of the shifted row/column (so, for shift purposes, the board is a Torus). KO rule- If a player has just shifted, the next player cannot shift that row/column. GOAL - A player wins when he makes a 5 in-a-row (orthogonal or diagonal). If a shift give both players a 5 in-a-row, wins the player that made that shift.
(game "Kassle" (players 2) (equipment {(board (square 5)) (piece "Square" Each)}) (rules (play (or {(move Add (to (sites Empty))) (move Select (from (forEach (sites Column (sub (count Columns) 1)) if:(not (all Sites (sites Row (row of:(site))) if:(is Empty (site)))))) (to (ahead (from) W) if:(not (is In (add (from) (to)) (sites Pending)))) (then (and {(forEach Site (sites Row (row of:(last From))) (remove (site))) (forEach Site (sites Row (row of:(last From))) (if (notEqual (ahead (site) W) (site)) (add (piece (what at:(site))) (to (ahead (site) W))) (add (piece (what at:(site))) (to (coord row:(row of:(last From)) column:(sub (count Columns) 1)))))) (set Pending (add (last From) (last To))) (set Pending (add (coord row:(row of:(last From)) column:0) (ahead (coord row:(row of:(last From)) column:0) E)))}))) (move Select (from (forEach (sites Column 0) if:(not (all Sites (sites Row (row of:(site))) if:(is Empty (site)))))) (to (ahead (from) E) if:(not (is In (add (from) (to)) (sites Pending)))) (then (and {(forEach Site (sites Row (row of:(last From))) (remove (site))) (forEach Site (sites Row (row of:(last From))) (if (notEqual (ahead (site) E) (site)) (add (piece (what at:(site))) (to (ahead (site) E))) (add (piece (what at:(site))) (to (coord row:(row of:(last From)) column:0))))) (set Pending (add (last From) (last To))) (set Pending (add (coord row:(row of:(last From)) column:(sub (count Columns) 1)) (ahead (coord row:(row of:(last From)) column:(sub (count Columns) 1)) W)))}))) (move Select (from (forEach (sites Row 0) if:(not (all Sites (sites Column (column of:(site))) if:(is Empty (site)))))) (to (ahead (from) N) if:(not (is In (add (from) (to)) (sites Pending)))) (then (and {(forEach Site (sites Column (column of:(last From))) (remove (site))) (forEach Site (sites Column (column of:(last From))) (if (notEqual (ahead (site) N) (site)) (add (piece (what at:(site))) (to (ahead (site) N))) (add (piece (what at:(site))) (to (coord row:0 column:(column of:(last From))))))) (set Pending (add (last From) (last To))) (set Pending (add (coord row:(sub (count Rows) 1) column:(column of:(last To))) (ahead (coord row:(sub (count Rows) 1) column:(column of:(last To))) S)))}))) (move Select (from (forEach (sites Row (sub (count Rows) 1)) if:(not (all Sites (sites Column (column of:(site))) if:(is Empty (site)))))) (to (ahead (from) S) if:(not (is In (add (from) (to)) (sites Pending)))) (then (and {(forEach Site (sites Column (column of:(last From))) (remove (site))) (forEach Site (sites Column (column of:(last From))) (if (notEqual (ahead (site) S) (site)) (add (piece (what at:(site))) (to (ahead (site) S))) (add (piece (what at:(site))) (to (coord row:(sub (count Rows) 1) column:(column of:(last From))))))) (set Pending (add (last From) (last To))) (set Pending (add (coord row:(sub (count Rows) 1) column:0) (ahead (coord row:(sub (count Rows) 1) column:0) N)))})))})) (end {(if (and (not (all Sites (sites Occupied by:P1) if:(not (is Line 5 through:(site))))) (not (all Sites (sites Occupied by:P2) if:(not (is Line 5 through:(site)))))) (result Mover Win)) (if (not (all Sites (sites Occupied by:P1) if:(not (is Line 5 through:(site))))) (result P1 Win)) (if (not (all Sites (sites Occupied by:P2) if:(not (is Line 5 through:(site))))) (result P2 Win))}))) 
